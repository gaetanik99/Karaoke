<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizza Karaoke - Serata Animatori</title>
    <style>
        /* === RESET E VARIABILI GLOBALI === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #ff6b6b;
            --secondary-color: #4ecdc4;
            --accent-color: #ffe66d;
            --background-dark: #2c3e50;
            --background-light: #34495e;
            --text-light: #ecf0f1;
            --text-dark: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --border-radius: 15px;
            --box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            --transition: all 0.3s ease;
        }

        /* === STILI GENERALI === */
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, var(--background-dark), var(--background-light));
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* === HEADER === */
        .header {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            padding: 20px;
            text-align: center;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.1) 10px,
                rgba(255,255,255,0.1) 20px
            );
            animation: slide 20s linear infinite;
        }

        @keyframes slide {
            0% { transform: translateX(-50px); }
            100% { transform: translateX(50px); }
        }

        .header h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.4rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* === CONTENITORE PRINCIPALE === */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === CONTROLLI PRINCIPALI === */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), #ff5252);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,107,0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, var(--secondary-color), #26a69a);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78,205,196,0.4);
        }

        .btn-accent {
            background: linear-gradient(45deg, var(--accent-color), #ffd54f);
            color: var(--text-dark);
        }

        .btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,230,109,0.4);
        }

        /* === AREA ESTRAZIONE === */
        .extraction-area {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 40px;
            margin: 30px 0;
            text-align: center;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .song-display {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 2px solid var(--accent-color);
            transition: var(--transition);
        }

        .song-display.extracting {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .countdown {
            font-size: 4rem;
            font-weight: bold;
            color: var(--accent-color);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* === GESTIONE CANZONI === */
        .song-management {
            display: none;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 30px;
            margin: 20px 0;
            box-shadow: var(--box-shadow);
        }

        .song-management.visible {
            display: block;
            animation: slideDown 0.5s ease;
        }
        

        
        /* Stile per i pulsanti di gestione */
        .management-toggle-btn {
            position: relative;
            overflow: hidden;
        }
        
        .management-toggle-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .management-toggle-btn:hover::after {
            left: 100%;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .song-input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .song-input-group .btn {
            white-space: nowrap;
        }

        .song-input {
            flex: 1;
            padding: 15px;
            font-size: 1.1rem;
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius);
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
            min-width: 250px;
        }

        .song-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .song-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255,230,109,0.3);
        }

        .songs-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius);
            background: rgba(0,0,0,0.2);
            padding: 15px;
        }

        .song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            transition: var(--transition);
        }

        .song-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }

        .song-title {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 20px;
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--error-color), #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231,76,60,0.4);
        }

        .btn-info {
            background: var(--info-color, #17a2b8);
            border-color: var(--info-color, #17a2b8);
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            border-color: #117a8b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52,152,219,0.4);
        }

        /* === STATISTICHE === */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* === ANIMAZIONI SPECIALI === */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--accent-color);
            animation: confetti-fall 3s linear infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* === GESTIONE PARTECIPANTI === */
        .participants-management {
            display: none;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 30px;
            margin: 20px 0;
            box-shadow: var(--box-shadow);
        }
        
        .participants-management.visible {
            display: block;
            animation: slideDown 0.5s ease;
        }
        
        .participants-section {
            margin-bottom: 30px;
        }
        
        .participants-section h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .participant-input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .participant-input {
            flex: 1;
            padding: 15px;
            font-size: 1.1rem;
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius);
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
            min-width: 200px;
        }
        
        .participant-select {
            flex: 1;
            padding: 15px;
            font-size: 1.1rem;
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius);
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
            min-width: 150px;
        }
        
        .participant-input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .participant-input:focus,
        .participant-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255,230,109,0.3);
        }
        
        .participant-select option {
            background: var(--primary-color);
            color: var(--text-light);
        }
        
        .participant-management-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .participants-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius);
            background: rgba(0,0,0,0.2);
            padding: 15px;
        }
        
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            transition: var(--transition);
        }
        
        .participant-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }
        
        .participant-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .participant-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-light);
        }
        
        .participant-team {
            font-size: 0.9rem;
            color: var(--accent-color);
            opacity: 0.8;
        }
        
        .team-badge {
            background: var(--accent-color);
            color: var(--primary-color);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 10px;
        }
        
        /* Select personalizzato */
        .custom-select {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            padding: 5px 8px;
            color: var(--text-light);
            font-size: 0.9rem;
            width: 100%;
            max-width: 150px;
        }
        
        .custom-select:focus {
            outline: none;
            border-color: var(--accent-color);
            background: rgba(255,255,255,0.2);
        }
        
        .custom-select option {
            background: var(--primary-color);
            color: var(--text-light);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .header p {
                font-size: 1.1rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .song-display {
                font-size: 1.8rem;
            }
            
            .song-input-group {
                flex-direction: column;
            }
            
            .song-input {
                min-width: auto;
            }
        }

        /* === STILI PER PROIEZIONE === */
        @media (min-width: 1200px) {
            .header h1 {
                font-size: 4rem;
            }
            
            .song-display {
                font-size: 3.5rem;
                min-height: 120px;
            }
            
            .btn {
                font-size: 1.4rem;
                padding: 20px 40px;
            }
        }

        /* === TOAST NOTIFICATIONS === */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--error-color);
        }

        .toast.warning {
            background: var(--warning-color);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* === ADMIN PASSWORD === */
        .admin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .admin-overlay.visible {
            display: flex;
        }

        .admin-modal {
            background: var(--background-light);
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--box-shadow);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .admin-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius);
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
            margin: 15px 0;
        }
        
        .admin-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255,230,109,0.3);
        }
        
        .admin-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        /* === TABELLE CANZONI === */
        .songs-tables {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .table-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .table-container h3 {
            margin: 0 0 15px 0;
            color: var(--accent-color);
            text-align: center;
            font-size: 1.3rem;
        }
        
        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            border-radius: var(--border-radius);
            border: 2px solid var(--secondary-color);
        }
        
        .songs-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0,0,0,0.2);
        }
        
        .songs-table th {
            background: var(--secondary-color);
            color: var(--text-light);
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .songs-table td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: var(--text-light);
        }
        
        .songs-table tbody tr:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .song-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
        }
        
        .status-available {
            background: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
            border: 1px solid #2ecc71;
        }
        
        .status-extracted {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .extraction-order {
            background: var(--accent-color);
            color: var(--primary-color);
            padding: 4px 8px;
            border-radius: 50%;
            font-weight: bold;
            text-align: center;
            min-width: 25px;
            display: inline-block;
        }
        
        /* === CAMPI EDITABILI TABELLA === */
        .editable-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            padding: 5px 8px;
            color: var(--text-light);
            font-size: 0.9rem;
            width: 100%;
            max-width: 120px;
        }
        
        .editable-input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: rgba(255,255,255,0.2);
        }
        
        .score-input {
            max-width: 60px;
            text-align: center;
        }
        
        .singer-input {
            max-width: 100px;
        }
        
        .btn-mini {
            padding: 4px 8px;
            font-size: 0.8rem;
            border-radius: 4px;
            margin: 0 2px;
        }
        
        .btn-save {
            background: var(--accent-color);
            color: var(--primary-color);
        }
        
        .btn-save:hover {
            background: #f1c40f;
        }
        
        /* === GESTIONE SQUADRE === */
        .teams-management {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--box-shadow);
        }
        
        .team-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .team-management-buttons,
        .participant-management-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .team-management-buttons .btn,
        .participant-management-buttons .btn {
            font-size: 0.9rem;
            padding: 10px 15px;
        }
        
        .team-input {
            flex: 1;
            padding: 10px;
            font-size: 1rem;
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius);
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
            min-width: 200px;
        }
        
        .team-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255,230,109,0.3);
        }
        
        .team-input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .teams-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .team-item {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 8px 15px;
            font-weight: bold;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .team-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .team-remove-btn {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            margin-left: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .team-remove-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }
        
        /* === CLASSIFICA === */
        .leaderboard-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 30px;
            margin: 30px 0;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .leaderboard-section h2 {
            text-align: center;
            color: var(--accent-color);
            margin-bottom: 25px;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .leaderboard-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .teams-leaderboard,
        .participants-leaderboard {
            margin-bottom: 30px;
        }
        
        .teams-leaderboard h3,
        .participants-leaderboard h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .leaderboard-table-wrapper {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(5px);
        }
        
        .leaderboard-table th {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .leaderboard-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.95rem;
        }
        
        .leaderboard-table tbody tr:hover {
            background: rgba(255,255,255,0.1);
            transition: var(--transition);
        }
        
        .position-cell {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .position-1 {
            color: #ffd700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .position-2 {
            color: #c0c0c0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .position-3 {
            color: #cd7f32;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .team-name {
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .participant-name {
            font-weight: bold;
            color: var(--text-light);
        }
        
        .score-total {
            font-weight: bold;
            color: var(--success-color);
            font-size: 1.1rem;
        }
        
        .score-average {
            color: var(--secondary-color);
            font-weight: bold;
        }
        
        .score-details {
            font-size: 0.8rem;
            color: var(--text-light);
            opacity: 0.8;
        }
        
        .no-scores {
            color: var(--warning-color);
            font-style: italic;
        }
        
        .participants-leaderboard.hidden {
            display: none;
        }
        
        .teams-leaderboard.hidden {
            display: none;
        }
        
        .participants-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .songs-count {
            background: var(--secondary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* Responsive per tabelle */
        @media (max-width: 768px) {
            .songs-tables {
                grid-template-columns: 1fr;
            }
            
            .songs-table th,
            .songs-table td {
                padding: 8px 4px;
                font-size: 0.9rem;
            }
            
            .table-wrapper {
                max-height: 300px;
            }
            
            .team-input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .team-input {
                min-width: auto;
            }
            
            .leaderboard-table th,
            .leaderboard-table td {
                padding: 8px 4px;
                font-size: 0.8rem;
            }
            
            .leaderboard-table-wrapper {
                max-height: 300px;
            }
            
            .score-details {
                max-width: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üçï Pizza Karaoke üé§</h1>
        <p>Serata Animatori - Venerd√¨ della Musica</p>
    </div>

    <!-- Contenitore principale -->
    <div class="container">
        <!-- Controlli principali -->
        <div class="controls">
            <button class="btn btn-primary" onclick="extractSong()" id="extractBtn">
                üé≤ Estrai Canzone
            </button>
            <button class="btn btn-secondary management-toggle-btn" onclick="toggleSongManagement()" id="songManagementBtn">
                üéµ Gestisci Canzoni
            </button>
            <button class="btn btn-secondary management-toggle-btn" onclick="toggleParticipantsManagement()" id="participantsManagementBtn">
                üë• Gestisci Partecipanti
            </button>
            <button class="btn btn-accent" onclick="document.getElementById('leaderboard-section').scrollIntoView({behavior: 'smooth'})">
                üèÜ Vai alla Classifica
            </button>
            <button class="btn btn-accent" onclick="resetExtractions()">
                üîÑ Reset Estrazioni
            </button>
            <!-- NUOVI PULSANTI BACKUP -->
            <button class="btn btn-primary" onclick="exportCompleteBackup()" title="Esporta backup completo">
                üíæ Backup Completo
            </button>
            <button class="btn btn-primary" onclick="document.getElementById('importCompleteBackupInput').click()" title="Importa backup completo">
                üìÇ Ripristina Backup
            </button>
            <button class="btn btn-danger" onclick="resetCompleteApplication()" title="Reset completo di tutti i dati">
                üóëÔ∏è Reset Completo
            </button>
        </div>
        
        <!-- Input nascosto per import backup completo -->
        <input type="file" id="importCompleteBackupInput" accept=".json" style="display: none;" onchange="handleCompleteBackupImport(event)">

        <!-- Area estrazione -->
        <div class="extraction-area">
            <h2>üéØ Canzone Estratta</h2>
            <div class="song-display" id="songDisplay">
                Premi "Estrai Canzone" per iniziare!
            </div>
            <div id="participantInfo" style="font-size: 1.2rem; margin-top: 15px; opacity: 0.8;"></div>
        </div>

        <!-- Statistiche -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalSongs">0</div>
                <div class="stat-label">Canzoni Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="extractedCount">0</div>
                <div class="stat-label">Canzoni Estratte</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="remainingCount">0</div>
                <div class="stat-label">Canzoni Rimanenti</div>
            </div>
        </div>

        <!-- Gestione canzoni -->
        <!-- Gestione canzoni -->
        <div class="song-management" id="songManagement">
            <h2>üéµ Gestione Canzoni</h2>
            <div class="song-input-group">
                <input type="text" class="song-input" id="songInput" placeholder="Inserisci il titolo della canzone..." maxlength="100">
                <button class="btn btn-secondary" onclick="addSong()">
                    ‚ûï Aggiungi
                </button>
                <button class="btn btn-accent" onclick="loadDefaultSongs()">
                    üìö Carica Canzoni Base
                </button>
                <button class="btn btn-danger" onclick="removeAllSongs()">
                    üóëÔ∏è Rimuovi Tutte
                </button>
                <button class="btn btn-primary" onclick="exportSongs()">
                    üì§ Esporta Lista
                </button>
                <button class="btn btn-primary" onclick="importSongs()">
                    üì• Importa Lista
                </button>
            </div>
            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">
            <div class="songs-list" id="songsList"></div>
        </div>

        <!-- Gestione Partecipanti -->
        <div class="participants-management" id="participantsManagement">
            <h2>üë• Gestione Partecipanti</h2>
            
            <!-- Gestione Squadre -->
            <div class="teams-management">
                <h3 style="color: var(--accent-color); margin-bottom: 15px;">üèÜ Gestione Squadre</h3>
                <div class="team-input-group">
                    <input type="text" class="team-input" id="teamNameInput" placeholder="Nome squadra..." maxlength="30">
                    <button class="btn btn-accent btn-small" onclick="addTeam()">
                        ‚ûï Aggiungi Squadra
                    </button>
                    <button class="btn btn-danger btn-small" onclick="removeAllTeams()">
                        üóëÔ∏è Rimuovi Tutte
                    </button>
                </div>
                <div class="team-management-buttons" style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                    <button class="btn btn-secondary btn-small" onclick="exportTeams()">
                        üì§ Esporta Squadre
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="document.getElementById('importTeamsFileInput').click()">
                        üì• Importa Squadre
                    </button>
                    <input type="file" id="importTeamsFileInput" accept=".json" style="display: none;" onchange="handleTeamsFileImport(event)">
                </div>
                <div class="teams-list" id="teamsList"></div>
            </div>
            
            <!-- Gestione Partecipanti -->
            <div class="participants-section">
                <h3>üë§ Gestione Partecipanti</h3>
                <div class="participant-input-group">
                    <input type="text" class="participant-input" id="participantName" placeholder="Nome partecipante..." maxlength="50">
                    <select class="participant-select" id="participantTeamSelect">
                        <option value="">Seleziona squadra...</option>
                    </select>
                    <button class="btn btn-secondary" onclick="addParticipant()">
                        üë§ Aggiungi Partecipante
                    </button>
                    <button class="btn btn-danger" onclick="removeAllParticipants()">
                        üóëÔ∏è Rimuovi Tutti
                    </button>
                </div>
                <div class="participant-management-buttons">
                    <button class="btn btn-secondary" onclick="exportParticipants()">
                        üì§ Esporta Partecipanti
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importParticipantsFileInput').click()">
                        üì• Importa Partecipanti
                    </button>
                    <button class="btn btn-accent" onclick="exportTeamsAndParticipants()">
                        üì¶ Esporta Tutto
                    </button>
                    <button class="btn btn-accent" onclick="document.getElementById('importAllFileInput').click()">
                        üì¶ Importa Tutto
                    </button>
                    <input type="file" id="importParticipantsFileInput" accept=".json" style="display: none;" onchange="handleParticipantsFileImport(event)">
                    <input type="file" id="importAllFileInput" accept=".json" style="display: none;" onchange="handleAllFileImport(event)">
                </div>
                <div class="participants-list" id="participantsList"></div>
            </div>
        </div>

        <!-- Classifica in Tempo Reale -->
        <div class="leaderboard-section" id="leaderboard-section">
            <h2>üèÜ Classifica in Tempo Reale</h2>
            
            <!-- Toggle per visualizzazione -->
            <div class="leaderboard-controls">
                <button class="btn btn-accent" id="toggleTeamView" onclick="toggleLeaderboardView()">
                    üë• Visualizza per Squadre
                </button>
                <button class="btn btn-secondary" onclick="refreshLeaderboard()">
                    üîÑ Aggiorna
                </button>
            </div>
            
            <!-- Classifica Squadre -->
            <div class="teams-leaderboard" id="teamsLeaderboard">
                <h3>üèÜ Classifica Squadre</h3>
                <div class="leaderboard-table-wrapper">
                    <table class="leaderboard-table" id="teamsLeaderboardTable">
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Squadra</th>
                                <th>Partecipanti</th>
                                <th>Canzoni</th>
                                <th>Punteggio Totale</th>
                                <th>Media</th>
                            </tr>
                        </thead>
                        <tbody id="teamsLeaderboardBody">
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Classifica Partecipanti -->
            <div class="participants-leaderboard" id="participantsLeaderboard">
                <h3>üë§ Classifica Partecipanti</h3>
                <div class="leaderboard-table-wrapper">
                    <table class="leaderboard-table" id="participantsLeaderboardTable">
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Partecipante</th>
                                <th>Squadra</th>
                                <th>Canzoni</th>
                                <th>Punteggio Totale</th>
                                <th>Media</th>
                                <th>Dettaglio Punteggi</th>
                            </tr>
                        </thead>
                        <tbody id="participantsLeaderboardBody">
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tabelle Canzoni -->
        <div class="songs-tables">
            <div class="table-container">
                <h3>üìã Tutte le Canzoni Disponibili</h3>
                <div class="table-wrapper">
                    <table class="songs-table" id="allSongsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Titolo Canzone</th>
                                <th>Stato</th>
                            </tr>
                        </thead>
                        <tbody id="allSongsTableBody">
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="table-container">
                <h3>üéØ Canzoni Gi√† Estratte</h3>
                <div class="table-wrapper">
                    <table class="songs-table" id="extractedSongsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Titolo Canzone</th>
                                <th>Cantante</th>
                                <th>Squadra</th>
                                <th>Punteggio</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="extractedSongsTableBody">
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>



    <script>
        // === CONFIGURAZIONE GLOBALE ===
        const CONFIG = {
            ADMIN_PASSWORD: 'pizza2024',
            STORAGE_KEY: 'pizzaKaraokeSongs',
            EXTRACTIONS_KEY: 'pizzaKaraokeExtractions',
            PARTICIPANTS_KEY: 'pizzaKaraokeParticipants',
            TEAMS_KEY: 'pizzaKaraokeTeams',
            ANIMATION_DURATION: 3000,
            CONFETTI_COUNT: 50
        };

        // === VARIABILI GLOBALI ===
        let songs = [];
        let extractedSongs = []; // Array di oggetti: {song, singer, score, extractionOrder, timestamp}
        let participants = []; // Array di oggetti: {name, team}
        let teams = []; // Array di stringhe: nomi delle squadre
        let isExtracting = false;
        let isAdminMode = false;
        let showTeamView = true; // Toggle per visualizzazione classifica
        let currentExtractedSong = null; // Canzone estratta ma non ancora salvata

        // === SQUADRE PREDEFINITE ===
        const DEFAULT_TEAMS = [
            "Squadra Rossa",
            "Squadra Blu",
            "Squadra Verde",
            "Squadra Gialla"
        ];

        // === CANZONI PREDEFINITE ===
        const DEFAULT_SONGS = [
            "Volare - Domenico Modugno",
            "Azzurro - Adriano Celentano",
            "Nel blu dipinto di blu - Domenico Modugno",
            "Caruso - Lucio Dalla",
            "Laura non c'√® - Nek",
            "Bella ciao - Canto popolare",
            "Sar√† perch√© ti amo - Ricchi e Poveri",
            "Felicit√† - Al Bano e Romina Power",
            "Tanti auguri a te - Tradizionale",
            "Amico - Lucio Battisti",
            "Imagine - John Lennon",
            "Bohemian Rhapsody - Queen",
            "Sweet Child O' Mine - Guns N' Roses",
            "Hotel California - Eagles",
            "Yesterday - The Beatles",
            "Hallelujah - Leonard Cohen",
            "Don't Stop Believin' - Journey",
            "Livin' on a Prayer - Bon Jovi",
            "Sweet Caroline - Neil Diamond",
            "My Way - Frank Sinatra",
            "Despacito - Luis Fonsi",
            "Shape of You - Ed Sheeran",
            "Uptown Funk - Mark Ronson ft. Bruno Mars",
            "Can't Stop the Feeling - Justin Timberlake",
            "Happy - Pharrell Williams",
            "Shake It Off - Taylor Swift",
            "Someone Like You - Adele",
            "Rolling in the Deep - Adele",
            "Counting Stars - OneRepublic",
            "Radioactive - Imagine Dragons",
            "Macarena - Los Del Rio",
            "YMCA - Village People",
            "I Will Survive - Gloria Gaynor",
            "Dancing Queen - ABBA",
            "Mamma Mia - ABBA",
            "Don't Stop Me Now - Queen",
            "We Are the Champions - Queen",
            "Eye of the Tiger - Survivor",
            "Footloose - Kenny Loggins",
            "Girls Just Want to Have Fun - Cyndi Lauper"
        ];

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadSongs();
            loadExtractions();
            loadTeams();
            loadParticipants();
            updateStats();
            updateSongsTables();
            updateTeamsList();
            updateTeamSelect();
            updateParticipantsList();
            updateLeaderboard();
            setupEventListeners();
            
            // Assicurati che le sezioni di gestione siano nascoste all'avvio
            hideSongManagement();
            hideParticipantsManagement();
            
            console.log('üçï Pizza Karaoke inizializzato!');
        }
        
        function setupEventListeners() {
            // Gestione input canzone con Enter
            document.getElementById('songInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addSong();
                }
            });
            
            // Gestione input partecipante con Enter
            document.getElementById('participantName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('participantTeamSelect').focus();
                }
            });
            
            document.getElementById('participantTeamSelect').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addParticipant();
                }
            });
            
            // Gestione input squadra con Enter
            document.getElementById('teamNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTeam();
                }
            });
            

            
            // Shortcuts da tastiera
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    extractSong();
                }
                if (e.ctrlKey && e.key === 'g') {
                    e.preventDefault();
                    toggleSongManagement();
                }
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    toggleParticipantsManagement();
                }
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    resetExtractions();
                }
            });
        }

        // === GESTIONE STORAGE ===
        function saveSongs() {
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(songs));
        }

        function loadSongs() {
            const savedSongs = localStorage.getItem(CONFIG.STORAGE_KEY);
            if (savedSongs) {
                songs = JSON.parse(savedSongs);
            } else {
                songs = [...DEFAULT_SONGS];
                saveSongs();
            }
        }

        function saveExtractions() {
            localStorage.setItem(CONFIG.EXTRACTIONS_KEY, JSON.stringify(extractedSongs));
        }

        function loadExtractions() {
            const savedExtractions = localStorage.getItem(CONFIG.EXTRACTIONS_KEY);
            if (savedExtractions) {
                const parsed = JSON.parse(savedExtractions);
                
                // Migrazione dati: se sono stringhe, convertile in oggetti
                if (parsed.length > 0 && typeof parsed[0] === 'string') {
                    extractedSongs = parsed.map((song, index) => ({
                        song: song,
                        singer: '',
                        score: '',
                        extractionOrder: index + 1,
                        timestamp: new Date().toISOString()
                    }));
                    saveExtractions(); // Salva nel nuovo formato
                } else {
                    extractedSongs = parsed;
                }
            }
        }

        // === STORAGE PARTECIPANTI ===
        function saveParticipants() {
            localStorage.setItem(CONFIG.PARTICIPANTS_KEY, JSON.stringify(participants));
        }
        
        function loadParticipants() {
            const savedParticipants = localStorage.getItem(CONFIG.PARTICIPANTS_KEY);
            if (savedParticipants) {
                participants = JSON.parse(savedParticipants);
                
                // Migrazione: aggiungi skipsUsed ai partecipanti esistenti che non ce l'hanno
                participants.forEach(participant => {
                    if (participant.skipsUsed === undefined) {
                        participant.skipsUsed = 0;
                    }
                });
                
                // Salva i dati migrati
                saveParticipants();
            }
        }

        // === STORAGE SQUADRE ===
        function saveTeams() {
            localStorage.setItem(CONFIG.TEAMS_KEY, JSON.stringify(teams));
        }
        
        function loadTeams() {
            const savedTeams = localStorage.getItem(CONFIG.TEAMS_KEY);
            if (savedTeams) {
                teams = JSON.parse(savedTeams);
            } else {
                teams = [...DEFAULT_TEAMS];
                saveTeams();
            }
        }

        // === GESTIONE CANZONI ===
        function addSong() {
            const input = document.getElementById('songInput');
            const songTitle = input.value.trim();
            
            if (songTitle === '') {
                showToast('Inserisci un titolo valido!', 'warning');
                return;
            }
            
            if (songs.includes(songTitle)) {
                showToast('Questa canzone √® gi√† presente!', 'warning');
                return;
            }
            
            songs.push(songTitle);
            saveSongs();
            updateStats();
            updateSongsList();
            input.value = '';
            
            showToast('Canzone aggiunta con successo! üéµ', 'success');
        }

        function removeSong(index) {
            if (confirm('Sei sicuro di voler rimuovere questa canzone?')) {
                const removedSong = songs.splice(index, 1)[0];
                
                // Rimuovi anche dalle canzoni estratte se presente
                const extractedIndex = extractedSongs.findIndex(item => item.song === removedSong);
                if (extractedIndex > -1) {
                    extractedSongs.splice(extractedIndex, 1);
                    saveExtractions();
                }
                
                saveSongs();
                updateStats();
                updateSongsList();
                updateSongsTables();
                
                showToast('Canzone rimossa!', 'success');
            }
        }

        function removeAllSongs() {
            if (songs.length === 0) {
                showToast('Non ci sono canzoni da rimuovere!', 'warning');
                return;
            }
            
            if (confirm('Sei sicuro di voler rimuovere TUTTE le canzoni? Questa azione non pu√≤ essere annullata!')) {
                songs = [];
                extractedSongs = [];
                
                saveSongs();
                saveExtractions();
                updateStats();
                updateSongsList();
                updateSongsTables();
                
                // Reset anche il display dell'estrazione
                document.getElementById('songDisplay').innerHTML = 'Premi "Estrai Canzone" per iniziare!';
                document.getElementById('participantInfo').innerHTML = '';
                
                showToast('Tutte le canzoni sono state rimosse! üóëÔ∏è', 'success');
            }
        }

        function loadDefaultSongs() {
            if (confirm('Questo sostituir√† tutte le canzoni attuali con quelle predefinite. Continuare?')) {
                songs = [...DEFAULT_SONGS];
                extractedSongs = [];
                saveSongs();
                saveExtractions();
                updateStats();
                updateSongsList();
                updateSongsTables();
                
                showToast('Canzoni predefinite caricate! üìö', 'success');
            }
        }

        function updateSongsList() {
            const songsList = document.getElementById('songsList');
            songsList.innerHTML = '';
            
            if (songs.length === 0) {
                songsList.innerHTML = '<p style="text-align: center; opacity: 0.7;">Nessuna canzone disponibile</p>';
                return;
            }
            
            songs.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                
                const isExtracted = extractedSongs.some(item => item.song === song);
                const statusIcon = isExtracted ? '‚úÖ' : 'üéµ';
                
                songItem.innerHTML = `
                    <span class="song-title">${statusIcon} ${song}</span>
                    <button class="btn btn-danger btn-small" onclick="removeSong(${index})">
                        üóëÔ∏è Rimuovi
                    </button>
                `;
                
                if (isExtracted) {
                    songItem.style.opacity = '0.6';
                }
                
                songsList.appendChild(songItem);
            });
            
            // Aggiorna anche le tabelle e la classifica
            updateSongsTables();
            updateLeaderboard();
        }

        // === GESTIONE TABELLE ===
        function updateSongsTables() {
            updateAllSongsTable();
            updateExtractedSongsTable();
        }
        
        function updateAllSongsTable() {
            const tableBody = document.getElementById('allSongsTableBody');
            tableBody.innerHTML = '';
            
            if (songs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; opacity: 0.6; padding: 20px;">Nessuna canzone disponibile</td></tr>';
                return;
            }
            
            songs.forEach((song, index) => {
                const isExtracted = extractedSongs.some(extracted => extracted.song === song);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td style="font-weight: bold; color: var(--accent-color);">${index + 1}</td>
                    <td style="font-weight: bold;">${song}</td>
                    <td>
                        <span class="song-status ${isExtracted ? 'status-extracted' : 'status-available'}">
                            ${isExtracted ? 'üéØ Estratta' : '‚úÖ Disponibile'}
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function updateExtractedSongsTable() {
            const tableBody = document.getElementById('extractedSongsTableBody');
            tableBody.innerHTML = '';
            
            if (extractedSongs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; opacity: 0.6; padding: 20px;">Nessuna canzone estratta ancora</td></tr>';
                return;
            }
            
            extractedSongs.forEach((extractedObj, index) => {
                const row = document.createElement('tr');
                
                // Crea select per partecipanti
                let participantOptions = '<option value="">Seleziona partecipante...</option>';
                participants.forEach(participant => {
                    const selected = extractedObj.singer === participant.name ? 'selected' : '';
                    participantOptions += `<option value="${participant.name}" data-team="${participant.team}" ${selected}>${participant.name} (${participant.team})</option>`;
                });
                
                row.innerHTML = `
                    <td style="font-weight: bold; color: var(--accent-color);">
                        <span class="extraction-order">${extractedObj.extractionOrder}</span>
                    </td>
                    <td style="font-weight: bold;">${extractedObj.song}</td>
                    <td>
                        <select class="custom-select" onchange="selectParticipant(${index}, this)">
                            ${participantOptions}
                        </select>
                    </td>
                    <td>
                        <span class="team-badge" id="teamBadge_${index}">
                            ${extractedObj.team || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <input type="number" 
                               class="editable-input score-input" 
                               value="${extractedObj.score || ''}" 
                               placeholder="0-10"
                               min="0" max="10" step="0.1"
                               onchange="updateExtractedSong(${index}, 'score', this.value)">
                    </td>
                    <td>
                        <button class="btn btn-mini btn-save" 
                                onclick="saveExtractedSongData(${index})" 
                                title="Salva modifiche">
                            üíæ
                        </button>
                        <button class="btn btn-mini btn-danger" 
                                onclick="removeExtractedSong(${index})" 
                                title="Rimuovi estrazione">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function selectParticipant(index, selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const participantName = selectedOption.value;
            const team = selectedOption.getAttribute('data-team') || '';
            
            if (extractedSongs[index]) {
                extractedSongs[index].singer = participantName;
                extractedSongs[index].team = team;
                
                // Aggiorna il badge della squadra
                const teamBadge = document.getElementById(`teamBadge_${index}`);
                if (teamBadge) {
                    teamBadge.textContent = team || 'N/A';
                }
                
                saveExtractions();
                updateLeaderboard();
                showToast('Partecipante assegnato! üë§', 'success');
            }
        }
        
        function updateExtractedSong(index, field, value) {
            if (extractedSongs[index]) {
                extractedSongs[index][field] = value;
                
                // Aggiorna anche la squadra se il cantante cambia
                if (field === 'singer') {
                    const participant = participants.find(p => p.name === value);
                    extractedSongs[index].team = participant ? participant.team : '';
                }
                
                // Auto-save dopo 1 secondo di inattivit√†
                clearTimeout(window.autoSaveTimeout);
                window.autoSaveTimeout = setTimeout(() => {
                    saveExtractions();
                    updateExtractedSongsTable();
                    updateLeaderboard(); // Aggiorna la classifica in tempo reale
                    showToast('Modifiche salvate automaticamente! üíæ', 'success');
                }, 1000);
            }
        }
        
        function saveExtractedSongData(index) {
            saveExtractions();
            showToast('Dati salvati! üíæ', 'success');
        }
        
        function removeExtractedSong(index) {
            if (confirm('Sei sicuro di voler rimuovere questa estrazione?')) {
                extractedSongs.splice(index, 1);
                
                // Riordina i numeri di estrazione
                extractedSongs.forEach((obj, i) => {
                    obj.extractionOrder = i + 1;
                });
                
                saveExtractions();
                updateStats();
                updateSongsTables();
                updateLeaderboard();
                showToast('Estrazione rimossa!', 'success');
            }
        }

        // === ESTRAZIONE CANZONI ===
        function extractSong() {
            if (isExtracting) return;
            
            const availableSongs = songs.filter(song => 
                !extractedSongs.some(extracted => extracted.song === song)
            );
            
            if (availableSongs.length === 0) {
                showToast('Tutte le canzoni sono state estratte! üéâ', 'warning');
                if (extractedSongs.length > 0) {
                    celebrateCompletion();
                }
                return;
            }
            
            isExtracting = true;
            
            // Countdown integrato
            const songDisplay = document.getElementById('songDisplay');
            let countdown = 3;
            
            const countdownInterval = setInterval(() => {
                songDisplay.innerHTML = `<div class="countdown">${countdown}</div>`;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(countdownInterval);
                    songDisplay.innerHTML = '<div class="countdown">Estrazione in corso...</div>';
                    
                    setTimeout(() => {
                        const randomIndex = Math.floor(Math.random() * availableSongs.length);
                        const selectedSong = availableSongs[randomIndex];
                        
                        // Salva la canzone estratta temporaneamente (NON in extractedSongs)
                        currentExtractedSong = {
                            song: selectedSong,
                            singer: '',
                            score: '',
                            extractionOrder: extractedSongs.length + 1,
                            timestamp: new Date().toISOString()
                        };
                        
                        displayExtractedSong(selectedSong);
                        createConfetti();
                        
                        showToast('Canzone estratta! üé§', 'success');
                        
                        // Mostra il form per inserire cantante e punteggio dopo un breve delay
                        setTimeout(() => {
                            showSingerScoreForm(-1); // -1 indica che √® una nuova estrazione
                        }, 2000);
                        
                        isExtracting = false;
                    }, 1000);
                }
            }, 1000);
        }

        function startExtractionAnimation() {
            const songDisplay = document.getElementById('songDisplay');
            const participantInfo = document.getElementById('participantInfo');
            
            songDisplay.classList.add('extracting');
            participantInfo.innerHTML = '';
            
            // Countdown
            let countdown = 3;
            const countdownInterval = setInterval(() => {
                songDisplay.innerHTML = `<span class="countdown">${countdown}</span>`;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(countdownInterval);
                    songDisplay.innerHTML = 'Estrazione in corso...';
                }
            }, 1000);
            
            // Memorizza l'intervallo per poterlo cancellare se necessario
            return countdownInterval;
        }



        function displayExtractedSong(song) {
            const songDisplay = document.getElementById('songDisplay');
            const participantInfo = document.getElementById('participantInfo');
            
            songDisplay.classList.remove('extracting');
            songDisplay.innerHTML = `üéµ ${song}`;
            
            // Informazioni per il partecipante
            const tips = [
                "Ricordati di divertirti! üéâ",
                "Non importa se sbagli, l'importante √® partecipare! üòä",
                "Fai sentire la tua voce! üé§",
                "Coinvolgi il pubblico! üë•",
                "Balla se ti va! üíÉüï∫"
            ];
            
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            participantInfo.innerHTML = `üí° ${randomTip}`;
        }

        // === EFFETTI SPECIALI ===
        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#ffa8a8'];
            
            for (let i = 0; i < CONFIG.CONFETTI_COUNT; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 3 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }, i * 50);
            }
        }

        // === GESTIONE STATISTICHE ===
        function updateStats() {
            const totalSongs = songs.length;
            const extractedCount = extractedSongs.length;
            const remainingCount = totalSongs - extractedCount;
            
            document.getElementById('totalSongs').textContent = totalSongs;
            document.getElementById('extractedCount').textContent = extractedCount;
            document.getElementById('remainingCount').textContent = remainingCount;
            
            // Aggiorna anche le tabelle
            updateSongsTables();
            updateLeaderboard(); // Aggiorna anche la classifica
        }

        // === GESTIONE ADMIN ===
        function toggleSongManagement() {
            const songManagement = document.getElementById('songManagement');
            const isVisible = songManagement.classList.contains('visible');
            
            if (isVisible) {
                hideSongManagement();
            } else {
                showSongManagement();
            }
        }

        function showSongManagement() {
            const songManagement = document.getElementById('songManagement');
            songManagement.classList.add('visible');
            document.getElementById('songInput').focus();
            
            // Scorri alla sezione
            songManagement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideSongManagement() {
            const songManagement = document.getElementById('songManagement');
            songManagement.classList.remove('visible');
        }

        // === GESTIONE PARTECIPANTI ===
        function toggleParticipantsManagement() {
            const management = document.getElementById('participantsManagement');
            const isVisible = management.classList.contains('visible');
            
            if (isVisible) {
                hideParticipantsManagement();
            } else {
                showParticipantsManagement();
            }
        }
        
        function showParticipantsManagement() {
            const management = document.getElementById('participantsManagement');
            management.classList.add('visible');
            
            // Scorri alla sezione
            management.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Focus sul primo campo disponibile
            const teamInput = document.getElementById('teamNameInput');
            const participantInput = document.getElementById('participantName');
            
            if (teams.length === 0) {
                teamInput.focus();
            } else {
                participantInput.focus();
            }
        }
        
        function hideParticipantsManagement() {
            const management = document.getElementById('participantsManagement');
            management.classList.remove('visible');
        }
        
        function addParticipant() {
            const name = document.getElementById('participantName').value.trim();
            const team = document.getElementById('participantTeamSelect').value;
            
            if (!name) {
                showToast('Inserisci il nome del partecipante!', 'warning');
                return;
            }
            
            if (!team) {
                showToast('Seleziona una squadra!', 'warning');
                return;
            }
            
            // Controlla se il partecipante esiste gi√†
            if (participants.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                showToast('Questo partecipante √® gi√† presente!', 'warning');
                return;
            }
            
            // Aggiungi il partecipante con il contatore dei salti
            participants.push({ 
                name: name, 
                team: team,
                skipsUsed: 0  // Nuovo campo per tracciare i salti utilizzati
            });
            
            saveParticipants();
            updateParticipantsList();
            updateLeaderboard();
            
            // Reset form
            document.getElementById('participantName').value = '';
            document.getElementById('participantTeamSelect').value = '';
            document.getElementById('participantName').focus();
            
            showToast(`${name} aggiunto alla ${team}! üé§`, 'success');
        }
        
        function removeParticipant(index) {
            if (confirm('Sei sicuro di voler rimuovere questo partecipante?')) {
                const removedParticipant = participants.splice(index, 1)[0];
                
                // Rimuovi dalle estrazioni se presente
                extractedSongs.forEach(extraction => {
                    if (extraction.singer === removedParticipant.name) {
                        extraction.singer = '';
                        extraction.team = '';
                    }
                });
                
                saveParticipants();
                saveExtractions();
                updateParticipantsList();
                updateExtractedSongsTable();
                
                showToast('Partecipante rimosso!', 'success');
            }
        }
        
        function removeAllParticipants() {
            if (participants.length === 0) {
                showToast('Non ci sono partecipanti da rimuovere!', 'warning');
                return;
            }
            
            if (confirm('Sei sicuro di voler rimuovere TUTTI i partecipanti?')) {
                participants = [];
                
                // Pulisci anche le estrazioni
                extractedSongs.forEach(extraction => {
                    extraction.singer = '';
                    extraction.team = '';
                });
                
                saveParticipants();
                saveExtractions();
                updateParticipantsList();
                updateExtractedSongsTable();
                
                showToast('Tutti i partecipanti sono stati rimossi! üóëÔ∏è', 'success');
            }
        }
        
        function updateParticipantsList() {
            const list = document.getElementById('participantsList');
            list.innerHTML = '';
            
            if (participants.length === 0) {
                list.innerHTML = '<div style="text-align: center; opacity: 0.6; padding: 20px;">Nessun partecipante registrato</div>';
                return;
            }
            
            // Raggruppa per squadra
            const teams = {};
            participants.forEach(participant => {
                if (!teams[participant.team]) {
                    teams[participant.team] = [];
                }
                teams[participant.team].push(participant);
            });
            
            Object.keys(teams).forEach(teamName => {
                const teamDiv = document.createElement('div');
                teamDiv.innerHTML = `<h4 style="color: var(--accent-color); margin: 15px 0 10px 0;">üèÜ Squadra: ${teamName}</h4>`;
                list.appendChild(teamDiv);
                
                teams[teamName].forEach((participant, teamIndex) => {
                    const globalIndex = participants.findIndex(p => p.name === participant.name);
                    const item = document.createElement('div');
                    item.className = 'participant-item';
                    
                    item.innerHTML = `
                        <div class="participant-info">
                            <div class="participant-name">${participant.name}</div>
                            <div class="participant-team">Squadra: ${participant.team}</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-small btn-info" onclick="editParticipantTeam(${globalIndex})" title="Modifica squadra">
                                ‚úèÔ∏è Modifica
                            </button>
                            <button class="btn btn-small btn-danger" onclick="removeParticipant(${globalIndex})">
                                üóëÔ∏è Rimuovi
                            </button>
                        </div>
                    `;
                    
                    list.appendChild(item);
                });
            });
        }

        function getRandomParticipant() {
            if (participants.length === 0) {
                return null;
            }
            
            const randomIndex = Math.floor(Math.random() * participants.length);
            return participants[randomIndex];
        }

        // === GESTIONE SQUADRE ===
        function addTeam() {
            const input = document.getElementById('teamNameInput');
            const teamName = input.value.trim();
            
            if (teamName === '') {
                showToast('Inserisci un nome squadra valido!', 'warning');
                return;
            }
            
            if (teams.includes(teamName)) {
                showToast('Questa squadra √® gi√† presente!', 'warning');
                return;
            }
            
            teams.push(teamName);
            saveTeams();
            updateTeamsList();
            updateTeamSelect();
            
            input.value = '';
            input.focus();
            
            showToast('Squadra aggiunta con successo! üèÜ', 'success');
        }
        
        function removeTeam(index) {
            if (confirm('Sei sicuro di voler rimuovere questa squadra?')) {
                const removedTeam = teams.splice(index, 1)[0];
                
                // Rimuovi la squadra dai partecipanti
                participants.forEach(participant => {
                    if (participant.team === removedTeam) {
                        participant.team = '';
                    }
                });
                
                // Rimuovi la squadra dalle estrazioni
                extractedSongs.forEach(extraction => {
                    if (extraction.team === removedTeam) {
                        extraction.team = '';
                    }
                });
                
                saveTeams();
                saveParticipants();
                saveExtractions();
                updateTeamsList();
                updateTeamSelect();
                updateParticipantsList();
                updateExtractedSongsTable();
                
                showToast('Squadra rimossa! üóëÔ∏è', 'success');
            }
        }
        
        function removeAllTeams() {
            if (confirm('Sei sicuro di voler rimuovere tutte le squadre?')) {
                teams = [];
                
                // Rimuovi le squadre dai partecipanti
                participants.forEach(participant => {
                    participant.team = '';
                });
                
                // Rimuovi le squadre dalle estrazioni
                extractedSongs.forEach(extraction => {
                    extraction.team = '';
                });
                
                saveTeams();
                saveParticipants();
                saveExtractions();
                updateTeamsList();
                updateTeamSelect();
                updateParticipantsList();
                updateExtractedSongsTable();
                
                showToast('Tutte le squadre sono state rimosse! üóëÔ∏è', 'success');
            }
        }
        
        function updateTeamsList() {
            const list = document.getElementById('teamsList');
            list.innerHTML = '';
            
            teams.forEach((team, index) => {
                const item = document.createElement('div');
                item.className = 'team-item';
                item.innerHTML = `
                    <span>${team}</span>
                    <button class="team-remove-btn" onclick="removeTeam(${index})" title="Rimuovi squadra">
                        ‚úï
                    </button>
                `;
                list.appendChild(item);
            });
        }
        
        function updateTeamSelect() {
            const select = document.getElementById('participantTeamSelect');
            select.innerHTML = '<option value="">Seleziona squadra...</option>';
            
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                select.appendChild(option);
            });
        }

        // === RESET SISTEMA ===
        function resetExtractions() {
            if (confirm('Sei sicuro di voler resettare tutte le estrazioni? Questo permetter√† di estrarre nuovamente tutte le canzoni.')) {
                extractedSongs = [];
                saveExtractions();
                updateStats();
                updateSongsList();
                updateSongsTables();
                
                document.getElementById('songDisplay').innerHTML = 'Premi "Estrai Canzone" per iniziare!';
                document.getElementById('participantInfo').innerHTML = '';
                
                showToast('Estrazioni resettate! üîÑ', 'success');
            }
        }

        // === TOAST NOTIFICATIONS ===
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // === UTILITY FUNCTIONS ===
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // === GESTIONE EVENTI SPECIALI ===
        function celebrateCompletion() {
            if (extractedSongs.length === songs.length && songs.length > 0) {
                setTimeout(() => {
                    alert('üéâ Complimenti! Tutte le canzoni sono state estratte! La serata √® stata un successo! üéâ');
                    createConfetti();
                }, 1000);
            }
        }

        // === GESTIONE CANTANTE E PUNTEGGIO ===
        function showSingerScoreForm(extractedIndex) {
            let extractedSong;
            
            // Se extractedIndex √® -1, usa la canzone estratta temporanea
            if (extractedIndex === -1) {
                extractedSong = currentExtractedSong;
            } else {
                extractedSong = extractedSongs[extractedIndex];
            }
            
            if (!extractedSong) {
                showToast('Errore: nessuna canzone da modificare!', 'error');
                return;
            }
            
            // Crea le opzioni per il select dei partecipanti
            let participantOptions = '<option value="">Seleziona partecipante...</option>';
            participants.forEach(participant => {
                const selected = extractedSong.singer === participant.name ? 'selected' : '';
                participantOptions += `<option value="${participant.name}" data-team="${participant.team}" ${selected}>${participant.name} (${participant.team})</option>`;
            });
            
            // Genera il link YouTube per la ricerca karaoke
            const songTitle = encodeURIComponent(extractedSong.song + ' karaoke');
            const youtubeSearchUrl = `https://www.youtube.com/results?search_query=${songTitle}`;
            
            const modal = document.createElement('div');
            modal.className = 'admin-overlay visible';
            modal.innerHTML = `
                <div class="admin-modal" style="min-width: 400px;">
                    <h3 style="color: var(--accent-color); margin-bottom: 20px;">üé§ Dettagli Esibizione</h3>
                    <p style="font-size: 1.1rem; margin-bottom: 15px; font-weight: bold;">${extractedSong.song}</p>
                    
                    <!-- Link YouTube Karaoke -->
                    <div style="margin-bottom: 20px; text-align: center;">
                        <a href="${youtubeSearchUrl}" target="_blank" class="btn btn-accent" 
                           style="background-color: #FF0000; border-color: #FF0000; color: white; text-decoration: none; display: inline-block; padding: 8px 16px; border-radius: 5px; font-size: 0.9rem;">
                            üéµ Cerca su YouTube Karaoke
                        </a>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome Cantante:</label>
                        ${participants.length > 0 ? `
            <select id="participantSelect" class="admin-input custom-select" style="margin-bottom: 10px; width: 100%; max-width: none;">
                ${participantOptions}
            </select>
            <div style="text-align: center; margin: 10px 0; opacity: 0.7;">oppure</div>
        ` : ''}
                        <input type="text" id="singerNameInput" class="admin-input" 
                               placeholder="Inserisci il nome del cantante..." 
                               value="${extractedSong.singer || ''}" maxlength="50">
                        
                        ${participants.length > 0 ? `
                            <div style="text-align: center; margin: 15px 0;">
                                <button id="randomSingerBtn" class="btn btn-info" onclick="selectRandomSinger(${extractedIndex})" 
                                        style="background-color: #17a2b8; border-color: #17a2b8; font-size: 0.9rem;">
                                    üé≤ Estrai Cantante Casuale
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Punteggio (1-10):</label>
                        <input type="number" id="scoreInput" class="admin-input" 
                               placeholder="Voto da 1 a 10" min="1" max="10" step="0.5"
                               value="${extractedSong.score || ''}">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveSingerScore(${extractedIndex})">
                            üíæ Salva
                        </button>
                        ${extractedIndex !== -1 ? `
                        <button class="btn btn-warning" onclick="skipExtractedSong(${extractedIndex})" 
                                style="background-color: #f39c12; border-color: #e67e22;">
                            ‚è≠Ô∏è Salta
                        </button>
                        ` : `
                        <button class="btn btn-warning" onclick="cancelExtraction()" 
                                style="background-color: #f39c12; border-color: #e67e22;">
                            ‚è≠Ô∏è Salta
                        </button>
                        `}
                        <button class="btn btn-secondary" onclick="${extractedIndex === -1 ? 'cancelExtraction()' : 'closeSingerScoreForm()'}">
                            ‚ùå Chiudi
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal)
            
            // Gestione cambio select partecipante
            if (participants.length > 0) {
                const participantSelect = document.getElementById('participantSelect');
                const singerInput = document.getElementById('singerNameInput');
                
                participantSelect.addEventListener('change', function() {
                    if (this.value) {
                        singerInput.value = this.value;
                    }
                });
                
                participantSelect.focus();
            } else {
                document.getElementById('singerNameInput').focus();
            }
            
            // Gestione Enter per salvare
            modal.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveSingerScore(extractedIndex);
                }
            });
        }
        
        function saveSingerScore(extractedIndex) {
            const singerName = document.getElementById('singerNameInput').value.trim();
            const score = parseFloat(document.getElementById('scoreInput').value);
            
            // Validazione punteggio
            if (score && (score < 1 || score > 10)) {
                showToast('Il punteggio deve essere tra 1 e 10!', 'warning');
                return;
            }
            
            if (extractedIndex === -1) {
                // Nuova estrazione - salva currentExtractedSong in extractedSongs
                if (!currentExtractedSong) {
                    showToast('Errore: nessuna canzone estratta da salvare!', 'error');
                    return;
                }
                
                // Aggiorna i dati della canzone estratta
                if (singerName) {
                    currentExtractedSong.singer = singerName;
                    // Trova la squadra del partecipante
                    const participant = participants.find(p => p.name === singerName);
                    currentExtractedSong.team = participant ? participant.team : '';
                }
                if (!isNaN(score) && score >= 1 && score <= 10) {
                    currentExtractedSong.score = score;
                }
                
                // Aggiungi a extractedSongs
                extractedSongs.push(currentExtractedSong);
                currentExtractedSong = null; // Reset
                
                // Aggiorna tutto
                saveExtractions();
                updateStats();
                updateSongsList();
                updateSongsTables();
                updateLeaderboard();
                
            } else {
                // Modifica di estrazione esistente
                if (singerName) {
                    extractedSongs[extractedIndex].singer = singerName;
                    // Trova la squadra del partecipante
                    const participant = participants.find(p => p.name === singerName);
                    extractedSongs[extractedIndex].team = participant ? participant.team : '';
                }
                if (!isNaN(score) && score >= 1 && score <= 10) {
                    extractedSongs[extractedIndex].score = score;
                }
                
                saveExtractions();
                updateSongsTables();
                updateLeaderboard();
            }
            
            closeSingerScoreForm();
            
            if (singerName || !isNaN(score)) {
                showToast('Dati salvati con successo! üíæ', 'success');
            }
        }
        
        function closeSingerScoreForm() {
            const modal = document.querySelector('.admin-overlay.visible');
            if (modal) {
                modal.remove();
            }
            
            // Se c'√® una canzone estratta non salvata, chiedi conferma
            if (currentExtractedSong) {
                if (confirm(`Hai una canzone estratta non salvata: "${currentExtractedSong.song}". Vuoi scartarla? (Torner√† disponibile per future estrazioni)`)) {
                    currentExtractedSong = null;
                    const songDisplay = document.getElementById('songDisplay');
                    songDisplay.innerHTML = 'Canzone scartata! Premi "Estrai Canzone" per continuare!';
                    document.getElementById('participantInfo').innerHTML = '';
                    showToast('Canzone scartata! üóëÔ∏è', 'warning');
                }
            }
        }
        
        function cancelExtraction() {
            if (confirm('Sei sicuro di voler annullare questa estrazione? La canzone torner√† disponibile.')) {
                // Reset della canzone estratta temporanea
                currentExtractedSong = null;
                
                // Reset del display
                const songDisplay = document.getElementById('songDisplay');
                songDisplay.innerHTML = 'Premi "Estrai Canzone" per continuare!';
                document.getElementById('participantInfo').innerHTML = '';
                
                closeSingerScoreForm();
                showToast('Estrazione annullata! La canzone √® di nuovo disponibile üîÑ', 'success');
            }
        }
        
        function editExtractedSong(extractedIndex) {
            showSingerScoreForm(extractedIndex);
        }
        
        // Nuova funzione per selezionare un cantante casuale
        function selectRandomSinger(extractedIndex) {
            // Se extractedIndex √® -1, usa currentExtractedSong
            const targetSong = extractedIndex === -1 ? currentExtractedSong : extractedSongs[extractedIndex];
            if (!targetSong) {
                showToast('Errore: nessuna canzone da assegnare!', 'error');
                return;
            }
            // Rimuovi la parte duplicata e continua con il codice esistente
            // Conta quante volte ha cantato ogni partecipante
            const singerCounts = {};
            participants.forEach(participant => {
                singerCounts[participant.name] = 0;
            });
            
            // Conta le canzoni cantate da ogni partecipante
            extractedSongs
                .filter(song => song.singer && song.singer.trim() !== '')
                .forEach(song => {
                    const singerName = song.singer.trim();
                    if (singerCounts.hasOwnProperty(singerName)) {
                        singerCounts[singerName]++;
                    }
                });
            
            // Trova il numero minimo di canzoni cantate
            const minSongs = Math.min(...Object.values(singerCounts));
            
            // Filtra i partecipanti che hanno cantato il numero minimo di volte
            const availableParticipants = participants.filter(participant => 
                singerCounts[participant.name] === minSongs
            );
            
            // Se non ci sono partecipanti registrati
            if (availableParticipants.length === 0) {
                showToast('Nessun partecipante registrato! üé§', 'warning');
                return;
            }
            
            const randomBtn = document.getElementById('randomSingerBtn');
            const participantSelect = document.getElementById('participantSelect');
            const singerInput = document.getElementById('singerNameInput');
            
            // Disabilita il pulsante durante l'estrazione
            randomBtn.disabled = true;
            randomBtn.style.opacity = '0.6';
            
            let countdown = 3;
            const originalText = randomBtn.innerHTML;
            
            const countdownInterval = setInterval(() => {
                randomBtn.innerHTML = `üé≤ Estrazione in corso... ${countdown}`;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(countdownInterval);
                    
                    // Seleziona un partecipante casuale tra quelli che hanno cantato meno
                    const randomIndex = Math.floor(Math.random() * availableParticipants.length);
                    const selectedParticipant = availableParticipants[randomIndex];
                    
                    // Aggiorna i campi
                    if (participantSelect) {
                        participantSelect.value = selectedParticipant.name;
                    }
                    singerInput.value = selectedParticipant.name;
                    
                    // Ripristina il pulsante
                    randomBtn.innerHTML = originalText;
                    randomBtn.disabled = false;
                    randomBtn.style.opacity = '1';
                    
                    // Mostra notifica con informazioni sul numero di canzoni
                    const currentCount = singerCounts[selectedParticipant.name];
                    showToast(`üé§ Estratto: ${selectedParticipant.name} (${selectedParticipant.team}) - ${currentCount + 1}¬™ canzone!`, 'success');
                    
                    // Effetto confetti
                    createConfetti();
                }
            }, 1000);
        }
        
        // Nuova funzione per saltare la canzone estratta
        function skipExtractedSong(extractedIndex) {
            if (extractedIndex === -1) {
                // Nuova estrazione - salta currentExtractedSong
                if (!currentExtractedSong) {
                    showToast('Errore: nessuna canzone da saltare!', 'error');
                    return;
                }
                
                if (confirm(`Sei sicuro di voler saltare la canzone "${currentExtractedSong.song}"? Torner√† disponibile per future estrazioni.`)) {
                    // Reset currentExtractedSong
                    currentExtractedSong = null;
                    
                    // Chiudi il popup
                    closeSingerScoreForm();
                    
                    // Aggiorna il display dell'estrazione
                    const songDisplay = document.getElementById('songDisplay');
                    songDisplay.innerHTML = 'Canzone saltata! Premi "Estrai Canzone" per continuare!';
                    document.getElementById('participantInfo').innerHTML = '';
                    
                    showToast('Canzone saltata! Ora √® di nuovo disponibile üîÑ', 'success');
                }
                return;
            }
            
            // Gestione per canzoni gi√† estratte
            const skippedSong = extractedSongs[extractedIndex];
            
            // Trova il partecipante che ha estratto la canzone
            const participant = participants.find(p => p.name === skippedSong.singer);
            
            if (participant) {
                // Controlla se ha gi√† utilizzato tutti i salti
                if (participant.skipsUsed >= 2) {
                    showToast(`${participant.name} ha gi√† utilizzato tutti i 2 salti disponibili! ‚ö†Ô∏è`, 'error');
                    return;
                }
                
                if (confirm(`Sei sicuro di voler saltare questa canzone? ${participant.name} avr√† ancora ${1 - participant.skipsUsed} salto/i disponibili.`)) {
                    // Incrementa il contatore dei salti
                    participant.skipsUsed++;
                    
                    // Rimuovi la canzone dalle estratte
                    extractedSongs.splice(extractedIndex, 1);
                    
                    // Riordina i numeri di estrazione
                    extractedSongs.forEach((obj, i) => {
                        obj.extractionOrder = i + 1;
                    });
                    
                    // Salva tutto
                    saveExtractions();
                    saveParticipants();
                    updateStats();
                    updateSongsTables();
                    updateLeaderboard();
                    
                    // Chiudi il popup
                    closeSingerScoreForm();
                    
                    // Aggiorna il display dell'estrazione
                    const songDisplay = document.getElementById('songDisplay');
                    songDisplay.innerHTML = 'Premi "Estrai Canzone" per continuare!';
                    document.getElementById('participantInfo').innerHTML = '';
                    
                    const remainingSkips = 2 - participant.skipsUsed;
                    showToast(`Canzone "${skippedSong.song}" saltata! ${participant.name} ha ancora ${remainingSkips} salto/i disponibili üîÑ`, 'success');
                }
            } else {
                // Fallback per canzoni senza cantante assegnato
                if (confirm('Sei sicuro di voler saltare questa canzone? Torner√† disponibile per future estrazioni.')) {
                    // Rimuovi la canzone dalle estratte
                    extractedSongs.splice(extractedIndex, 1);
                    
                    // Riordina i numeri di estrazione
                    extractedSongs.forEach((obj, i) => {
                        obj.extractionOrder = i + 1;
                    });
                    
                    // Salva e aggiorna tutto
                    saveExtractions();
                    updateStats();
                    updateSongsTables();
                    updateLeaderboard();
                    
                    // Chiudi il popup
                    closeSingerScoreForm();
                    
                    // Aggiorna il display dell'estrazione
                    const songDisplay = document.getElementById('songDisplay');
                    songDisplay.innerHTML = 'Premi "Estrai Canzone" per continuare!';
                    document.getElementById('participantInfo').innerHTML = '';
                    
                    showToast(`Canzone "${skippedSong.song}" saltata! Ora √® di nuovo disponibile üîÑ`, 'success');
                }
            }
        }

        // === IMPORT/EXPORT FUNCTIONS ===
        function exportSongs() {
            if (songs.length === 0) {
                showToast('Non ci sono canzoni da esportare!', 'warning');
                return;
            }
            
            const exportData = {
                songs: songs,
                extractedSongs: extractedSongs,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pizza-karaoke-songs-${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast(`Lista esportata con successo! (${songs.length} canzoni) üì§`, 'success');
        }
        
        function exportTeamsAndParticipants() {
            const dataToExport = {
                teams: teams,
                participants: participants,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pizza_karaoke_completo_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('Dati completi esportati con successo! üì¶', 'success');
        }
        
        function exportTeams() {
            if (teams.length === 0) {
                showToast('Nessuna squadra da esportare!', 'warning');
                return;
            }
            
            const dataToExport = {
                teams: teams,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pizza_karaoke_squadre_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('Squadre esportate con successo! üì§', 'success');
        }
        
        function exportParticipants() {
            if (participants.length === 0) {
                showToast('Nessun partecipante da esportare!', 'warning');
                return;
            }
            
            const dataToExport = {
                participants: participants,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pizza_karaoke_partecipanti_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('Partecipanti esportati con successo! üì§', 'success');
        }
        
        function importSongs() {
            document.getElementById('importFileInput').click();
        }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/json') {
                showToast('Seleziona un file JSON valido!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Verifica la struttura del file
                    if (!importData.songs || !Array.isArray(importData.songs)) {
                        throw new Error('Formato file non valido');
                    }
                    
                    // Chiedi conferma se ci sono gi√† canzoni
                    if (songs.length > 0) {
                        const action = confirm(
                            `Hai gi√† ${songs.length} canzoni nella lista.\n\n` +
                            `Clicca OK per SOSTITUIRE la lista attuale con quella importata (${importData.songs.length} canzoni)\n` +
                            `Clicca Annulla per AGGIUNGERE le canzoni importate a quelle esistenti`
                        );
                        
                        if (action) {
                            // Sostituisci
                            songs = [...importData.songs];
                            // Gestisci il formato delle canzoni estratte (compatibilit√†)
                            if (importData.extractedSongs && Array.isArray(importData.extractedSongs)) {
                                extractedSongs = importData.extractedSongs.map((item, index) => {
                                    if (typeof item === 'string') {
                                        // Formato vecchio - converti
                                        return {
                                            song: item,
                                            singer: null,
                                            score: null,
                                            extractionOrder: index + 1,
                                            timestamp: new Date().toISOString()
                                        };
                                    }
                                    return item; // Formato nuovo
                                });
                            } else {
                                extractedSongs = [];
                            }
                        } else {
                            // Aggiungi (evitando duplicati)
                            const newSongs = importData.songs.filter(song => !songs.includes(song));
                            songs = [...songs, ...newSongs];
                            
                            if (newSongs.length === 0) {
                                showToast('Tutte le canzoni importate erano gi√† presenti!', 'warning');
                                return;
                            }
                            
                            showToast(`${newSongs.length} nuove canzoni aggiunte! (${importData.songs.length - newSongs.length} duplicate ignorate)`, 'success');
                        }
                    } else {
                        // Lista vuota, importa tutto
                        songs = [...importData.songs];
                        // Gestisci il formato delle canzoni estratte (compatibilit√†)
                        if (importData.extractedSongs && Array.isArray(importData.extractedSongs)) {
                            extractedSongs = importData.extractedSongs.map((item, index) => {
                                if (typeof item === 'string') {
                                    // Formato vecchio - converti
                                    return {
                                        song: item,
                                        singer: null,
                                        score: null,
                                        extractionOrder: index + 1,
                                        timestamp: new Date().toISOString()
                                    };
                                }
                                return item; // Formato nuovo
                            });
                        } else {
                            extractedSongs = [];
                        }
                    }
                    
                    // Salva e aggiorna
                    saveSongs();
                    saveExtractions();
                    updateStats();
                    updateSongsList();
                    updateSongsTables();
                    
                    if (songs.length > 0) {
                        showToast(`Lista importata con successo! (${songs.length} canzoni totali) üì•`, 'success');
                    }
                    
                } catch (error) {
                    console.error('Errore durante l\'importazione:', error);
                    showToast('Errore: File non valido o corrotto!', 'error');
                }
            };
            
            reader.readAsText(file);
            
            // Reset input per permettere di selezionare lo stesso file
            event.target.value = '';
        }
        
        function handleAllFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    let importedCount = 0;
                    
                    // Importa squadre se presenti
                    if (importedData.teams && Array.isArray(importedData.teams)) {
                        const newTeams = importedData.teams.filter(team => !teams.includes(team));
                        teams.push(...newTeams);
                        importedCount += newTeams.length;
                        saveTeams();
                        updateTeamsList();
                        updateTeamSelect();
                    }
                    
                    // Importa partecipanti se presenti
                    if (importedData.participants && Array.isArray(importedData.participants)) {
                        const newParticipants = importedData.participants.filter(p => 
                            !participants.some(existing => existing.name === p.name)
                        );
                        participants.push(...newParticipants);
                        importedCount += newParticipants.length;
                        saveParticipants();
                        updateParticipantsList();
                        updateExtractedSongsTable();
                    }
                    
                    if (importedCount > 0) {
                        showToast(`${importedCount} elementi importati con successo! üì¶`, 'success');
                    } else {
                        showToast('Nessun nuovo elemento da importare!', 'warning');
                    }
                    
                } catch (error) {
                    showToast('Errore durante l\'importazione del file!', 'error');
                    console.error('Errore importazione completa:', error);
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }
        
        function handleTeamsFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Verifica formato
                    if (!importedData.teams || !Array.isArray(importedData.teams)) {
                        showToast('Formato file non valido!', 'error');
                        return;
                    }
                    
                    const importedTeams = importedData.teams;
                    
                    if (importedTeams.length === 0) {
                        showToast('Nessuna squadra trovata nel file!', 'warning');
                        return;
                    }
                    
                    // Controlla duplicati
                    const duplicates = importedTeams.filter(team => teams.includes(team));
                    
                    if (duplicates.length > 0) {
                        const action = confirm(
                            `Trovate ${duplicates.length} squadre duplicate:\n${duplicates.join(', ')}\n\n` +
                            'Vuoi sostituire le squadre esistenti? (OK = Sostituisci, Annulla = Aggiungi solo nuove)'
                        );
                        
                        if (action) {
                            // Sostituisci tutto
                            teams = [...importedTeams];
                        } else {
                            // Aggiungi solo nuove
                            const newTeams = importedTeams.filter(team => !teams.includes(team));
                            teams.push(...newTeams);
                        }
                    } else {
                        // Nessun duplicato, aggiungi tutto
                        teams.push(...importedTeams);
                    }
                    
                    saveTeams();
                    updateTeamsList();
                    updateTeamSelect();
                    
                    showToast(`${importedTeams.length} squadre importate con successo! üì•`, 'success');
                    
                } catch (error) {
                    showToast('Errore durante l\'importazione del file!', 'error');
                    console.error('Errore importazione squadre:', error);
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }
        
        function handleParticipantsFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Verifica formato
                    if (!importedData.participants || !Array.isArray(importedData.participants)) {
                        showToast('Formato file non valido!', 'error');
                        return;
                    }
                    
                    const importedParticipants = importedData.participants;
                    
                    if (importedParticipants.length === 0) {
                        showToast('Nessun partecipante trovato nel file!', 'warning');
                        return;
                    }
                    
                    // Controlla duplicati
                    const duplicates = importedParticipants.filter(p => 
                        participants.some(existing => existing.name === p.name)
                    );
                    
                    if (duplicates.length > 0) {
                        const action = confirm(
                            `Trovati ${duplicates.length} partecipanti duplicati:\n${duplicates.map(p => p.name).join(', ')}\n\n` +
                            'Vuoi sostituire i partecipanti esistenti? (OK = Sostituisci, Annulla = Aggiungi solo nuovi)'
                        );
                        
                        if (action) {
                            // Sostituisci tutto
                            participants = [...importedParticipants];
                        } else {
                            // Aggiungi solo nuovi
                            const newParticipants = importedParticipants.filter(p => 
                                !participants.some(existing => existing.name === p.name)
                            );
                            participants.push(...newParticipants);
                        }
                    } else {
                        // Nessun duplicato, aggiungi tutto
                        participants.push(...importedParticipants);
                    }
                    
                    saveParticipants();
                    updateParticipantsList();
                    updateExtractedSongsTable();
                    
                    showToast(`${importedParticipants.length} partecipanti importati con successo! üì•`, 'success');
                    
                } catch (error) {
                    showToast('Errore durante l\'importazione del file!', 'error');
                    console.error('Errore importazione partecipanti:', error);
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // === MODIFICA SQUADRA PARTECIPANTE ===
        function editParticipantTeam(participantIndex) {
            const participant = participants[participantIndex];
            if (!participant) {
                showToast('Partecipante non trovato!', 'error');
                return;
            }
            
            // Crea le opzioni per il select delle squadre
            let teamOptions = '<option value="">Nessuna squadra</option>';
            teams.forEach(team => {
                const selected = participant.team === team ? 'selected' : '';
                teamOptions += `<option value="${team}" ${selected}>${team}</option>`;
            });
            
            const modal = document.createElement('div');
            modal.className = 'admin-overlay visible';
            modal.innerHTML = `
                <div class="admin-modal" style="min-width: 400px;">
                    <h3 style="color: var(--accent-color); margin-bottom: 20px;">‚úèÔ∏è Modifica Squadra</h3>
                    <p style="font-size: 1.1rem; margin-bottom: 15px; font-weight: bold;">Partecipante: ${participant.name}</p>
                    
                    <p style="margin-bottom: 15px; opacity: 0.8;">Squadra attuale: ${participant.team || 'Nessuna'}</p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nuova Squadra:</label>
                        <select id="newTeamSelect" class="admin-input custom-select" style="width: 100%; max-width: none;">
                            ${teamOptions}
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveParticipantTeam(${participantIndex})">
                            üíæ Salva
                        </button>
                        <button class="btn btn-secondary" onclick="closeEditParticipantModal()">
                            ‚ùå Annulla
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('newTeamSelect').focus();
            
            // Gestione Enter per salvare
            modal.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveParticipantTeam(participantIndex);
                }
            });
        }
        
        function saveParticipantTeam(participantIndex) {
            const newTeam = document.getElementById('newTeamSelect').value;
            const participant = participants[participantIndex];
            const oldTeam = participant.team;
            
            // Aggiorna la squadra del partecipante
            participant.team = newTeam;
            
            // Aggiorna anche le estrazioni esistenti di questo partecipante
            extractedSongs.forEach(extraction => {
                if (extraction.singer === participant.name) {
                    extraction.team = newTeam;
                }
            });
            
            // Salva i dati
            saveParticipants();
            saveExtractions();
            
            // Aggiorna le visualizzazioni
            updateParticipantsList();
            updateExtractedSongsTable();
            updateLeaderboard();
            
            // Chiudi la modale
            closeEditParticipantModal();
            
            // Mostra messaggio di successo
            const teamMessage = newTeam ? `squadra "${newTeam}"` : 'nessuna squadra';
            const oldTeamMessage = oldTeam ? `"${oldTeam}"` : 'nessuna squadra';
            showToast(`Squadra di ${participant.name} cambiata da ${oldTeamMessage} a ${teamMessage}! ‚úèÔ∏è`, 'success');
        }
        
        // Funzione per chiudere la modale di modifica
        function closeEditParticipantModal() {
            const modal = document.querySelector('.admin-overlay.visible');
            if (modal) {
                modal.remove();
            }
        }

        // === SHORTCUTS INFO ===
        function showShortcuts() {
            const shortcuts = `
                üéπ SHORTCUTS TASTIERA:
                ‚Ä¢ Ctrl + E = Estrai Canzone
                ‚Ä¢ Ctrl + G = Gestisci Canzoni
                ‚Ä¢ Ctrl + P = Gestisci Partecipanti
                ‚Ä¢ Ctrl + R = Reset Estrazioni
                ‚Ä¢ Enter = Conferma (nei campi di input)
            `;
            alert(shortcuts);
        }

        // === GESTIONE CLASSIFICA ===
        function toggleLeaderboardView() {
            showTeamView = !showTeamView;
            const teamsDiv = document.getElementById('teamsLeaderboard');
            const participantsDiv = document.getElementById('participantsLeaderboard');
            const toggleBtn = document.getElementById('toggleTeamView');
            
            if (showTeamView) {
                teamsDiv.classList.remove('hidden');
                participantsDiv.classList.add('hidden');
                toggleBtn.textContent = 'üë§ Visualizza per Partecipanti';
                toggleBtn.className = 'btn btn-secondary';
            } else {
                teamsDiv.classList.add('hidden');
                participantsDiv.classList.remove('hidden');
                toggleBtn.textContent = 'üë• Visualizza per Squadre';
                toggleBtn.className = 'btn btn-accent';
            }
        }
        
        function refreshLeaderboard() {
            updateLeaderboard();
            showToast('Classifica aggiornata! üîÑ', 'success');
        }
        
        function updateLeaderboard() {
            updateTeamsLeaderboard();
            updateParticipantsLeaderboard();
        }
        
        function calculateTeamStats() {
            const teamStats = {};
            
            // Inizializza statistiche per tutte le squadre
            teams.forEach(team => {
                teamStats[team] = {
                    name: team,
                    participants: [],
                    totalScore: 0,
                    songCount: 0,
                    average: 0
                };
            });
            
            // Aggiungi partecipanti alle squadre
            participants.forEach(participant => {
                if (participant.team && teamStats[participant.team]) {
                    teamStats[participant.team].participants.push(participant.name);
                }
            });
            
            // Calcola punteggi dalle estrazioni
            extractedSongs.forEach(extraction => {
                if (extraction.singer && extraction.score && !isNaN(parseFloat(extraction.score))) {
                    const participant = participants.find(p => p.name === extraction.singer);
                    if (participant && participant.team && teamStats[participant.team]) {
                        teamStats[participant.team].totalScore += parseFloat(extraction.score);
                        teamStats[participant.team].songCount++;
                    }
                }
            });
            
            // Calcola medie
            Object.values(teamStats).forEach(team => {
                if (team.songCount > 0) {
                    team.average = (team.totalScore / team.songCount).toFixed(1);
                }
            });
            
            return Object.values(teamStats).sort((a, b) => b.totalScore - a.totalScore);
        }
        
        function calculateParticipantStats() {
            const participantStats = {};
            
            // Inizializza statistiche per tutti i partecipanti
            participants.forEach(participant => {
                participantStats[participant.name] = {
                    name: participant.name,
                    team: participant.team || 'Nessuna squadra',
                    totalScore: 0,
                    songCount: 0,
                    average: 0,
                    scores: []
                };
            });
            
            // Calcola punteggi dalle estrazioni
            extractedSongs.forEach(extraction => {
                if (extraction.singer && extraction.score && !isNaN(parseFloat(extraction.score))) {
                    if (participantStats[extraction.singer]) {
                        const score = parseFloat(extraction.score);
                        participantStats[extraction.singer].totalScore += score;
                        participantStats[extraction.singer].songCount++;
                        participantStats[extraction.singer].scores.push({
                            song: extraction.song,
                            score: score
                        });
                    }
                }
            });
            
            // Calcola medie
            Object.values(participantStats).forEach(participant => {
                if (participant.songCount > 0) {
                    participant.average = (participant.totalScore / participant.songCount).toFixed(1);
                }
            });
            
            return Object.values(participantStats).sort((a, b) => b.totalScore - a.totalScore);
        }
        
        function updateTeamsLeaderboard() {
            const teamStats = calculateTeamStats();
            const tbody = document.getElementById('teamsLeaderboardBody');
            tbody.innerHTML = '';
            
            if (teamStats.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="no-scores">Nessuna squadra disponibile</td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            teamStats.forEach((team, index) => {
                const row = document.createElement('tr');
                const position = index + 1;
                const positionClass = position <= 3 ? `position-${position}` : '';
                
                row.innerHTML = `
                    <td class="position-cell ${positionClass}">${position}</td>
                    <td class="team-name">${team.name}</td>
                    <td>${team.participants.length} (${team.participants.join(', ') || 'Nessuno'})</td>
                    <td>${team.songCount}</td>
                    <td class="score-total">${team.totalScore.toFixed(1)}</td>
                    <td class="score-average">${team.average || '0.0'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function updateParticipantsLeaderboard() {
            const participantStats = calculateParticipantStats();
            const tbody = document.getElementById('participantsLeaderboardBody');
            tbody.innerHTML = '';
            
            if (participantStats.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="no-scores">Nessun partecipante disponibile</td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            participantStats.forEach((participant, index) => {
                const row = document.createElement('tr');
                const position = index + 1;
                const positionClass = position <= 3 ? `position-${position}` : '';
                
                const scoresDetail = participant.scores.length > 0 
                    ? participant.scores.map(s => `${s.score}`).join(', ')
                    : 'Nessun punteggio';
                
                row.innerHTML = `
                    <td class="position-cell ${positionClass}">${position}</td>
                    <td class="participant-name">${participant.name}</td>
                    <td class="team-name">${participant.team}</td>
                    <td>${participant.songCount}</td>
                    <td class="score-total">${participant.totalScore.toFixed(1)}</td>
                    <td class="score-average">${participant.average || '0.0'}</td>
                    <td class="score-details">${scoresDetail}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Funzione per chiudere tutte le sezioni di gestione
        function closeAllManagementSections() {
            hideSongManagement();
            hideParticipantsManagement();
        }
        
        // Aggiungi shortcut per chiudere le sezioni (ESC)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAllManagementSections();
            }
        });

        // Aggiungi shortcut per mostrare gli shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                showShortcuts();
            }
        });

        // === BACKUP COMPLETO ===
        function exportCompleteBackup() {
            const backupData = {
                // Metadati del backup
                backupInfo: {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    description: 'Backup completo Pizza Karaoke - Include tutto: canzoni, partecipanti, squadre, estrazioni e punteggi'
                },
                
                // Dati principali
                songs: songs,
                teams: teams,
                participants: participants,
                extractedSongs: extractedSongs,
                
                // Statistiche calcolate (per verifica)
                stats: {
                    totalSongs: songs.length,
                    totalTeams: teams.length,
                    totalParticipants: participants.length,
                    totalExtractions: extractedSongs.length,
                    extractionsWithScores: extractedSongs.filter(e => e.score && !isNaN(parseFloat(e.score))).length
                }
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pizza_karaoke_backup_completo_${new Date().toISOString().split('T')[0]}_${new Date().toTimeString().split(' ')[0].replace(/:/g, '-')}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast(`üíæ Backup completo esportato con successo!\nüìä ${backupData.stats.totalSongs} canzoni, ${backupData.stats.totalParticipants} partecipanti, ${backupData.stats.totalExtractions} estrazioni`, 'success');
        }
        
        function handleCompleteBackupImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/json') {
                showToast('‚ùå Seleziona un file JSON valido!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Verifica la struttura del backup
                    if (!backupData.backupInfo || !backupData.songs || !backupData.teams || !backupData.participants) {
                        throw new Error('Formato backup non valido - dati mancanti');
                    }
                    
                    // Mostra informazioni del backup
                    const backupInfo = backupData.backupInfo;
                    const stats = backupData.stats || {};
                    
                    const confirmMessage = `üîÑ RIPRISTINO BACKUP COMPLETO\n\n` +
                        `üìÖ Data backup: ${new Date(backupInfo.exportDate).toLocaleString('it-IT')}\n` +
                        `üìä Contenuto:\n` +
                        `   ‚Ä¢ ${stats.totalSongs || backupData.songs.length} canzoni\n` +
                        `   ‚Ä¢ ${stats.totalTeams || backupData.teams.length} squadre\n` +
                        `   ‚Ä¢ ${stats.totalParticipants || backupData.participants.length} partecipanti\n` +
                        `   ‚Ä¢ ${stats.totalExtractions || (backupData.extractedSongs ? backupData.extractedSongs.length : 0)} estrazioni\n\n` +
                        `‚ö†Ô∏è ATTENZIONE: Questo sostituir√† TUTTI i dati attuali!\n\n` +
                        `Vuoi continuare con il ripristino?`;
                    
                    if (!confirm(confirmMessage)) {
                        showToast('‚ùå Ripristino annullato dall\'utente', 'warning');
                        return;
                    }
                    
                    // Ripristina tutti i dati
                    songs = Array.isArray(backupData.songs) ? [...backupData.songs] : [];
                    teams = Array.isArray(backupData.teams) ? [...backupData.teams] : [];
                    participants = Array.isArray(backupData.participants) ? [...backupData.participants] : [];
                    
                    // Ripristina estrazioni con controllo formato
                    if (Array.isArray(backupData.extractedSongs)) {
                        extractedSongs = backupData.extractedSongs.map((item, index) => {
                            if (typeof item === 'string') {
                                // Formato vecchio - converti
                                return {
                                    song: item,
                                    singer: '',
                                    score: '',
                                    extractionOrder: index + 1,
                                    timestamp: new Date().toISOString(),
                                    team: ''
                                };
                            }
                            // Assicurati che abbia tutti i campi necessari
                            return {
                                song: item.song || '',
                                singer: item.singer || '',
                                score: item.score || '',
                                extractionOrder: item.extractionOrder || index + 1,
                                timestamp: item.timestamp || new Date().toISOString(),
                                team: item.team || ''
                            };
                        });
                    } else {
                        extractedSongs = [];
                    }
                    
                    // Salva tutto nel localStorage
                    saveSongs();
                    saveTeams();
                    saveParticipants();
                    saveExtractions();
                    
                    // Aggiorna tutta l'interfaccia
                    updateStats();
                    updateSongsList();
                    updateSongsTables();
                    updateTeamsList();
                    updateTeamSelect();
                    updateParticipantsList();
                    updateExtractedSongsTable();
                    updateLeaderboard();
                    
                    // Aggiorna il display dell'estrazione
                    const songDisplay = document.getElementById('songDisplay');
                    songDisplay.innerHTML = 'Backup ripristinato! Premi "Estrai Canzone" per continuare!';
                    
                    // Messaggio di successo
                    const successMessage = `‚úÖ BACKUP RIPRISTINATO CON SUCCESSO!\n\n` +
                        `üìä Dati ripristinati:\n` +
                        `   ‚Ä¢ ${songs.length} canzoni\n` +
                        `   ‚Ä¢ ${teams.length} squadre\n` +
                        `   ‚Ä¢ ${participants.length} partecipanti\n` +
                        `   ‚Ä¢ ${extractedSongs.length} estrazioni\n\n` +
                        `üéâ Tutto pronto per continuare la gara!`;
                    
                    showToast(successMessage, 'success');
                    
                } catch (error) {
                    console.error('Errore durante il ripristino del backup:', error);
                    showToast(`‚ùå Errore durante il ripristino del backup:\n${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
            
            // Reset input per permettere di selezionare lo stesso file
            event.target.value = '';
        }
        
        // === RESET COMPLETO ===
        function resetCompleteApplication() {
            // Prima conferma
            const firstConfirm = confirm(
                '‚ö†Ô∏è ATTENZIONE: RESET COMPLETO\n\n' +
                'Questa operazione canceller√† TUTTI i dati:\n' +
                '‚Ä¢ Tutte le canzoni\n' +
                '‚Ä¢ Tutte le squadre\n' +
                '‚Ä¢ Tutti i partecipanti\n' +
                '‚Ä¢ Tutte le estrazioni e punteggi\n' +
                '‚Ä¢ Tutta la cronologia\n\n' +
                '‚ùå QUESTA OPERAZIONE NON PU√í ESSERE ANNULLATA!\n\n' +
                'Sei sicuro di voler continuare?'
            );
            
            if (!firstConfirm) {
                showToast('‚ùå Reset annullato', 'warning');
                return;
            }
            
            // Seconda conferma di sicurezza
            const secondConfirm = confirm(
                'üö® ULTIMA CONFERMA\n\n' +
                'Stai per cancellare DEFINITIVAMENTE tutti i dati.\n\n' +
                'SUGGERIMENTO: Prima di procedere, crea un backup completo ' +
                'usando il pulsante "üíæ Backup Completo" se vuoi poter ' +
                'ripristinare i dati in futuro.\n\n' +
                'Vuoi davvero procedere con il reset completo?'
            );
            
            if (!secondConfirm) {
                showToast('‚ùå Reset annullato - Operazione sicura', 'warning');
                return;
            }
            
            // Terza conferma finale con digitazione
            const finalConfirm = prompt(
                'üîê CONFERMA FINALE\n\n' +
                'Per procedere con il reset completo, digita esattamente:\n' +
                'RESET COMPLETO\n\n' +
                '(Maiuscole e minuscole contano)'
            );
            
            if (finalConfirm !== 'RESET COMPLETO') {
                showToast('‚ùå Reset annullato - Testo di conferma errato', 'warning');
                return;
            }
            
            try {
                // Mostra messaggio di elaborazione
                showToast('üîÑ Esecuzione reset completo in corso...', 'warning');
                
                // Cancella tutti i dati dalle variabili
                songs = [];
                teams = [];
                participants = [];
                extractedSongs = [];
                
                // Cancella tutto dal localStorage
                localStorage.removeItem(CONFIG.STORAGE_KEY);
                localStorage.removeItem(CONFIG.EXTRACTIONS_KEY);
                localStorage.removeItem(CONFIG.PARTICIPANTS_KEY);
                localStorage.removeItem(CONFIG.TEAMS_KEY);
                
                // Cancella anche eventuali altri dati correlati
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.includes('pizzaKaraoke')) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // Reset delle variabili di stato
                isExtracting = false;
                isAdminMode = false;
                showTeamView = true;
                
                // Aggiorna tutta l'interfaccia
                updateStats();
                updateSongsList();
                updateSongsTables();
                updateTeamsList();
                updateTeamSelect();
                updateParticipantsList();
                updateExtractedSongsTable();
                updateLeaderboard();
                
                // Reset del display dell'estrazione
                const songDisplay = document.getElementById('songDisplay');
                songDisplay.innerHTML = 'Applicazione resettata! Premi "Estrai Canzone" per iniziare!';
                
                // Nascondi tutte le sezioni di gestione
                hideAllManagementSections();
                
                // Reset dei pulsanti
                const extractBtn = document.getElementById('extractBtn');
                if (extractBtn) {
                    extractBtn.disabled = false;
                    extractBtn.textContent = 'üé≤ Estrai Canzone';
                }
                
                // Messaggio di successo
                setTimeout(() => {
                    showToast(
                        '‚úÖ RESET COMPLETO ESEGUITO CON SUCCESSO!\n\n' +
                        'üÜï L\'applicazione √® stata completamente resettata.\n' +
                        'üìù Puoi ora iniziare una nuova gara da zero.\n' +
                        'üí° Aggiungi canzoni, squadre e partecipanti per iniziare!',
                        'success'
                    );
                }, 500);
                
            } catch (error) {
                console.error('Errore durante il reset completo:', error);
                showToast('‚ùå Errore durante il reset completo: ' + error.message, 'error');
            }
        }
        
        // Funzione helper per nascondere tutte le sezioni di gestione
        function hideAllManagementSections() {
            const songManagement = document.getElementById('songManagement');
            const participantsManagement = document.getElementById('participantsManagement');
            
            if (songManagement) {
                songManagement.classList.remove('visible');
            }
            if (participantsManagement) {
                participantsManagement.classList.remove('visible');
            }
            
            // Reset dei pulsanti di gestione
            const songManagementBtn = document.getElementById('songManagementBtn');
            const participantsManagementBtn = document.getElementById('participantsManagementBtn');
            
            if (songManagementBtn) {
                songManagementBtn.textContent = 'üéµ Gestisci Canzoni';
            }
            if (participantsManagementBtn) {
                participantsManagementBtn.textContent = 'üë• Gestisci Partecipanti';
            }
        }
    </script>
</body>
</html>